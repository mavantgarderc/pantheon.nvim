name: CI

on:
  push:
    branches: [main, dev, refactor]
  pull_request:
    branches: [main, dev, refactor]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint (luacheck + stylua)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Lua, Luarocks, and luacheck
        run: |
          sudo apt-get update
          sudo apt-get install -y lua5.1 luarocks
          sudo luarocks install luacheck

      - name: Run luacheck
        run: |
          luacheck . lua/* plugin/*

      - name: Run stylua (format check)
        uses: JohnnyMorganz/stylua-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # You can pin to a specific version instead of "latest" if you prefer (e.g. "0.20.0").
          version: latest
          args: --check .

  neovim-startup:
    name: Neovim startup sanity check
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Neovim
        run: |
          sudo apt-get update
          sudo apt-get install -y neovim

      - name: Minimal startup test
        run: |
          cat << 'EOF' > minimal_init.lua
          -- Add current repo to runtimepath so lua/<plugin> and plugin/ are visible.
          vim.cmd("set rtp^=.")

          -- Adjust this require + setup for the repo you're using:
          -- For prismpunk.nvim:
          -- require("prismpunk").setup({ theme = "lantern-corps/green" })
          --
          -- For raphael.nvim:
          -- require("raphael").setup({})
          EOF

          nvim --headless -u minimal_init.lua -c 'qa'

  tests:
    name: Tests (Neovim + plenary)
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Neovim and git
        run: |
          sudo apt-get update
          sudo apt-get install -y neovim git

      - name: Install plenary.nvim
        run: |
          mkdir -p deps
          git clone --depth=1 https://github.com/nvim-lua/plenary.nvim deps/plenary.nvim

      - name: Run plenary tests (if any)
        run: |
          # Minimal init that adds plugin and plenary to runtimepath
          cat << 'EOF' > minimal_init.lua
          vim.cmd("set rtp^=.")
          vim.cmd("set rtp^=" .. vim.fn.fnamemodify("deps/plenary.nvim", ":p"))
          EOF

          # If there is no tests/ directory, this will just not run any tests and exit cleanly.
          if [ -d tests ]; then
            nvim --headless -u minimal_init.lua \
              -c "PlenaryBustedDirectory tests/ { minimal_init = 'minimal_init.lua' }" \
              -c "qa"
          else
            echo "No tests/ directory found; skipping plenary tests."
          fi

  docs-lint:
    name: Docs lint (markdownlint)
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install markdownlint-cli
        run: |
          sudo apt-get update
          sudo apt-get install -y npm
          sudo npm install -g markdownlint-cli

      - name: Run markdownlint
        run: |
          markdownlint "**/*.md" || (echo "Markdown issues found. Fix them or add .markdownlint.json to configure rules." && exit 1)
